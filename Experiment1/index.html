<!DOCTYPE html>
<html>
    <head>
        <title>Gold collecting experiment!</title>
        <!-- jspsych plugins -->
        <script src="jspsych/jspsych.js"></script>
        <script src="jspsych/plugin-html-keyboard-response.js"></script>
        <script src="jspsych/plugin-html-button-response.js"></script>
        <script src="jspsych/plugin-image-keyboard-response.js"></script>
        <script src="jspsych/plugin-instructions.js"></script>
        <script src="jspsych/plugin-survey-multi-choice.js"></script>
        <script src="jspsych/plugin-fullscreen.js"></script>
        <script src="jspsych/plugin-preload.js"></script>
        <!-- jspsych plugins for surveys -->
        <script src="jsQ/plugin-survey-demo.js"></script>
        <script src="jsQ/plugin-survey-feedback.js"></script>
        <script src="jsQ/plugin-survey-template.js"></script>
        <!-- my self-written code -->
        <script src="js/rooms.js"></script>
        <script src="js/consent.js"></script>
        <script src="js/script.js"></script>
        <script src="js/jspsychtrials.js"></script>
        <script src="js/plugin-comprehension.js"></script>
        <!-- surveys -->
        <script src="jsQ/ius12.js"></script>
        <script src="jsQ/loc74.js"></script>
        <!-- css -->
        <link href="jspsych/jspsych.css" rel="stylesheet" type="text/css" />
        <link href="css/style.css" rel="stylesheet">
    </head>
    <body></body>
    <script>
        //------------------------------------//
        // Debugging mode?
        //------------------------------------//
        debuggingmode = true
        if (debuggingmode){
            // variables controlling number of trials when debugging
            var n_limited_trials = 15;   // number of trials for selecting rooms
        }else{
            // during the test phase, both variable must be put to -1:
            var n_limited_trials = -1;   // all pairs of rooms will be presented
        }

        //------------------------------------//
        // Main parameters
        //------------------------------------//
        // trial counter
        var selection_trial = 0;

        // bonus
        var collected_gold = 0;
        
        var last_collected_gold = 0;
        var delta_collected_gold = 0;
        const feedback_period = 7;
        const break_period = 3;

        const min_gold = 40;    // exact value: 44
        const max_gold = 91;
        const max_bonus = 3;


        //------------------------------------//
        // Making the timline
        //------------------------------------//
        const redirect_link = "https://google.com";
        var jsPsych = initJsPsych({
            show_progress_bar: true,
            on_finish: function() {
                minimum_valid_rt: 100;

                // redirecting to Prolific
                setTimeout(function () {
                    window.location.replace(redirect_link);
                }, 1000);
            }
        });
        var timeline = [];
        
        
        //------------------------------------//
        // subject ID generator
        //------------------------------------//
        // readout prolific subject ID
        var pid = null;
        let id = null;
        
        //------------------------------------//
        // Preloading all images
        //------------------------------------//
        const instr_ind_1end = 17
        const instr_ind_2end = 25
        const instr_ind_3end = 48

        var preload = {
            type: jsPsychPreload,
            images: function(){
                var pages = ["img/BaseAction.png", "img/Agent.png", "img/Target.png", "img/Goal.png", "img/Cross.png"]
                for(i = 1; i <= instr_ind_3end; i++){
                    pages.push("img/Instructions/Slide" + i + ".png")
                }
                for(i = 1; i <= 4; i++){
                    pages.push("img/Comprehension/Slide" + i + ".png")
                }
                return pages
            }
        };
        timeline.push(preload);

        //------------------------------------//
        // Full screen and welcome
        //------------------------------------//
        var fullscreen = {
            type: jsPsychFullscreen,
            fullscreen_mode: true
        }
        timeline.push(fullscreen);
        
        //------------------------------------//
        // Instruction: Part 1
        //------------------------------------//
        var instr = {
            type: jsPsychInstructions,
            pages: function(){
                var pages = []
                for(i = 1; i <= instr_ind_1end; i++){
                    pages.push(
                        "<img src='./img/Instructions/Slide" + i +
                        ".png' style='max-width: 75%'></img>"
                    )
                }
                return pages
            },
            show_clickable_nav: true,
            button_label_previous: "Prev",
            button_label_next: "Next",
            data: {
                task: 'instruction'
            }
        }
        timeline.push(instr)

        //------------------------------------//
        // Moving Practice
        //------------------------------------//
        room_index = 1
        var movegrid = make_movegrid_trial(room_index)
        var movegridresult = make_movegridresult_trial(room_index)
        var test_procedure_grid = {
            timeline: [fixation, movegrid, movegridresult],
            repetitions: 3
        };
        timeline.push(test_procedure_grid);
    
        var instr1_newroom = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `<h2>Awesome!</h2>` + `<h3>Let's try out a random room.</h3>`,
            choices: ['Continue']
        };
        timeline.push(instr1_newroom);

        room_index = 2
        var movegridresult = make_movegridresult_trial(room_index)
        // fixing the stochastic outcome based on the choice of i
        var prac_index = [3,2,1]
        for (i = 0; i < prac_index.length; i++) {
            var movegrid = make_movegrid_practice_trial(room_index, prac_index[i])
            var test_procedure_grid = {
                timeline: [fixation, movegrid, movegridresult],
                repetitions: 1
            };
            timeline.push(test_procedure_grid);
        }
        
        var instr1_end = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `<h2>Great!</h2>` +
                `<h4>That was a lot of practice.</h4>
                <h4>Let's move on.</h4>`,
            choices: ['Continue']
        };
        timeline.push(instr1_end);

        //------------------------------------//
        // Instruction: Part 2
        //------------------------------------//
        var instr = {
            type: jsPsychInstructions,
            pages: function(){
                var pages = []
                for(i = (instr_ind_1end+1); i <= instr_ind_2end; i++){
                    pages.push(
                        "<img src='./img/Instructions/Slide" + i +
                        ".png' style='max-width: 75%'></img>"
                    )
                }
                return pages
            },
            show_clickable_nav: true,
            button_label_previous: "Prev",
            button_label_next: "Next",
            data: {
                task: 'instruction'
            }
        }
        timeline.push(instr)

        //------------------------------------//
        // Gold-collecting practice
        //------------------------------------//
        room_index = 1
        var seegrid = make_seegridgoal_trial(room_index)
        var movegridgoalresult = make_movegridgoalresult_trial(room_index)
        // fixing the stochastic outcome based on the choice of i
        var prac_index = [[1,0],[3,0],[5,0],[4,0],[0,0]]
        for (i = 0; i < prac_index.length; i++) {
            var movegridgoal = make_movegridgoal_practice_trial(room_index,prac_index[i][0],prac_index[i][1])
            var test_procedure_grid = {
                timeline: [fixation, seegrid, movegridgoal, movegridgoalresult],
                repetitions: 1
            };
            timeline.push(test_procedure_grid);
        }
        
        var instr1_newroom = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `<h2>Awesome!</h2>` + `<h3>Let's try out a random room.</h3>`,
            choices: ['Continue']
        };
        timeline.push(instr1_newroom);

        room_index = 2
        var seegrid = make_seegridgoal_trial(room_index)
        var movegridgoalresult = make_movegridgoalresult_trial(room_index)
        // fixing the stochastic outcome based on the choice of i
        var prac_index = [[1,2],[7,2],[5,1],[4,1],[0,3]]
        for (i = 0; i < prac_index.length; i++) {
            var movegridgoal = make_movegridgoal_practice_trial(room_index,prac_index[i][0],prac_index[i][1])
            var test_procedure_grid = {
                timeline: [fixation, seegrid, movegridgoal, movegridgoalresult],
                repetitions: 1
            };
            timeline.push(test_procedure_grid);
        }
        
        var instr2_end = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `<h2>Great!</h2>` +
                    `<h4>That was a lot of practice for now.</h4>
                     <h4>Let's move on.</h4>`,
            choices: ['Continue']
        };
        timeline.push(instr2_end);


        //------------------------------------//
        // Instruction: Part 3
        //------------------------------------//
        var instr = {
            type: jsPsychInstructions,
            pages: function(){
                var pages = []
                for(i = (instr_ind_2end+1); i <= instr_ind_3end; i++){
                    pages.push(
                        "<img src='./img/Instructions/Slide" + i +
                        ".png' style='max-width: 75%'></img>"
                    )
                }
                return pages
            },
            show_clickable_nav: true,
            button_label_previous: "Prev",
            button_label_next: "Next",
            data: {
                task: 'instruction'
            }
        }
        timeline.push(instr)

        //------------------------------------//
        // Room selecting practice
        //------------------------------------//
        var room_pair_index_practice = [[0,9], [3,10], [4,7]]
        for (let i = 0; i < room_pair_index_practice.length; i++) { 
            var room_index_1 = room_pair_index_practice[i][0];
            var room_index_2 = room_pair_index_practice[i][1];
            if (room_index_1 != room_index_2){
                var roomsel = make_roomselection_trial(room_index_1, room_index_2, false);
                var roomselresult = make_showselectedroom_trial()
                var roomselpracfeedback = make_roomselpracfeedback_trial(room_index_1, room_index_2)
                var test_procedure_selection = {
                    timeline: [fixation, roomsel, roomselresult, roomselpracfeedback]
                };
                timeline.push(test_procedure_selection);
            }
        }
        var instr3_end = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `<h2>You are all set!</h2>` +
                    `<h4>But, before we start, let's check if everything is clear.</h4>`,
            choices: ['Continue']
        };
        timeline.push(instr3_end);

        //------------------------------------//
        // Comprehension test
        //------------------------------------//
        var comprehension = {
            type: jsPsychGold1stepComprehension,
            data: {
                task: 'comprehension'
            }
        }
        timeline.push(comprehension)

        var comprehension2 = {
            type: jsPsychGold1stepComprehension2,
            data: {
                task: 'comprehension'
            }
        }
        timeline.push(comprehension2)
        
        var ready_trial = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `<h2>Awesome!</h2>` + 
                      `<h1>Ready to start the experiment?</h1>` + 
                      `<h2 style="color: red;">Remember: We will NOT show you the gold collecting process.</h2>` + 
                      `<h2 style="color: red;">We show you your total earned bonus ONCE EVERY FEW TRIALS.</h2>` ,
            choices: ['Continue']
        };
        timeline.push(ready_trial);

        //------------------------------------//
        // The main experiment
        //------------------------------------//
        const n_rooms = allrooms.length
        var room_pair_index = [];
        for (let i = 0; i < n_rooms; i++) { 
            for (let j = 0; j < n_rooms; j++) { 
                room_pair_index.push([i, j]);
            }
        }
        room_pair_index = jsPsych.randomization.sampleWithoutReplacement(room_pair_index, room_pair_index.length);
        if(n_limited_trials < 1){
            n_limited_trials = room_pair_index.length
        }
        for (let i = 0; i < n_limited_trials; i++) { 
            var room_index_1 = room_pair_index[i][0];
            var room_index_2 = room_pair_index[i][1];
            if (room_index_1 != room_index_2){
                var roomsel = make_roomselection_trial(room_index_1, room_index_2);
                var roomselresult = make_showselectedroom_trial()
                var test_procedure_selection = {
                    timeline: [fixation, roomsel, roomselresult]
                };
                timeline.push(test_procedure_selection);
            }
            if(((i+1) % feedback_period) == 0){
                timeline.push(gold_feedback_trial);
            }
            if(((i+1) % (break_period*feedback_period)) == 0){
                timeline.push(break_trial);
            }
        }

        //------------------------------------//
        // Quest
        //------------------------------------//
        var ToQuest = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `<h2>You were GREAT!</h2>` + 
                    `<h1> The last step is to answer some short questions.</h1>` +
                    `<h2 style="color: red;">You can skip any question that you do not want to answer.</h2>`,
            choices: ['Continue']
        };
        timeline.push(ToQuest);

        // Define demographics form.
        var demog = {
            type: jsPsychSurveyDemo,
            data: {
                task: 'demog'
            }
        }
        // Define feedback form.
        var expfeedback = {
            type: jsPsychSurveyFeedback,
            frustration: false,
            data: {
                task: 'expfeedback'
            }
        }
        timeline.push(loc74_1);
        timeline.push(loc74_2);
        timeline.push(ius12);
        timeline.push(demog);
        timeline.push(expfeedback);


        //------------------------------------//
        // ByeBye trial
        //------------------------------------//
        var byebye = {
            type: jsPsychHtmlButtonResponse,
            stimulus: `<h2>You were GREAT! </h2>` + 
                    `<h1>Thank you for your participation!</h1>`,
            choices: ['Bye bye!'],
            on_load: function(){
                // bonus computation
                var bonus = 0.5 + (collected_gold - min_gold) / (max_gold - min_gold) * (max_bonus - 0.5);
                jsPsych.data.addProperties({
                    Bonus: bonus
                });
            }
        };
        timeline.push(byebye);

        // exit fullscreen mode
        var fullscreen_off = {
            type: jsPsychFullscreen,
            fullscreen_mode: false
        }
        timeline.push(fullscreen_off);
        
        //------------------------------------//
        // Run the experiment
        //------------------------------------//
        jsPsych.run(timeline);

    </script>
</html>